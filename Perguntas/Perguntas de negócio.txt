1 - Quantos alunos ativos existem em cada plano atualmente?

WITH ativos AS (
    SELECT 
        a.plano_id,
        COUNT(*) AS total_ativos
    FROM Assinatura a
    JOIN Alunos al ON al.aluno_id = a.aluno_id
    WHERE a.status = 1 AND al.ativo = 1
    GROUP BY a.plano_id
)
SELECT 
    p.nome AS plano,
    ISNULL(at.total_ativos, 0) AS alunos_ativos
FROM Planos p
LEFT JOIN ativos at ON p.plano_id = at.plano_id;

2- Quanto cada aluno já pagou no total à academia?

SELECT 
    al.nome,
    SUM(pg.valor) AS total_pago
FROM Alunos al
JOIN Assinatura a ON al.aluno_id = a.aluno_id
JOIN Pagamento pg ON pg.assinatura_id = a.assinatura_id
WHERE pg.status = 1  -- pagos
GROUP BY al.nome
ORDER BY total_pago DESC;

3-Quais instrutores têm mais treinos agendados neste mês e qual é o ranking deles?

WITH TreinosMes AS (
    SELECT 
        t.instrutor_id,
        COUNT(*) AS total_treinos
    FROM Treinos t
    WHERE 
        MONTH(t.data_hora) = MONTH(GETDATE())
        AND YEAR(t.data_hora) = YEAR(GETDATE())
    GROUP BY t.instrutor_id
),
RankingInstrutores AS (
    SELECT 
        tm.instrutor_id,
        tm.total_treinos,
        DENSE_RANK() OVER (ORDER BY tm.total_treinos DESC) AS ranking
    FROM TreinosMes tm
)
SELECT 
    i.nome AS instrutor,
    r.total_treinos,
    r.ranking
FROM RankingInstrutores r
JOIN Instrutores i ON i.instrutor_id = r.instrutor_id
ORDER BY r.ranking, r.total_treinos DESC;

4 - Número de faltas por plano contratado

SELECT 
    p.nome AS plano,
    p.preco_mensal,
    COUNT(*) AS total_faltas
FROM Presencas pr
JOIN Alunos a ON pr.aluno_id = a.aluno_id
JOIN Assinatura s ON s.aluno_id = a.aluno_id
JOIN Planos p ON p.plano_id = s.plano_id
WHERE pr.presente = 0
GROUP BY p.nome, p.preco_mensal
ORDER BY total_faltas DESC;


-- 5 - Planos mais vendidos por mês
WITH VendasMensais AS (
    SELECT
        FORMAT(A.inicio, 'yyyy-MM') AS AnoMes, 
        P.nome AS NomePlano,
        COUNT(A.assinatura_id) AS TotalVendas
    FROM Assinatura A
    JOIN Planos P ON A.plano_id = P.plano_id
    GROUP BY FORMAT(A.inicio, 'yyyy-MM'), P.nome
),
ClassificacaoVendas AS (
    SELECT
        AnoMes,
        NomePlano,
        TotalVendas,
        RANK() OVER (PARTITION BY AnoMes ORDER BY TotalVendas DESC) AS RankVendas
    FROM VendasMensais
)
SELECT
    CV.AnoMes,
    CV.NomePlano,
    CV.TotalVendas
FROM ClassificacaoVendas CV
WHERE CV.RankVendas = 1
ORDER BY CV.AnoMes;

-- 4 - Número de faltas por plano contratado
SELECT
    P.nome AS NomePlano,
    COUNT(DISTINCT A.aluno_id) AS TotalAlunosAtivosNoPlano,
    SUM(dbo.fn_ContarFaltasAluno(A.aluno_id)) AS TotalFaltasAcumuladas
FROM Planos P
JOIN Assinatura ASS ON P.plano_id = ASS.plano_id
JOIN Alunos A ON ASS.aluno_id = A.aluno_id
WHERE ASS.status = 1
GROUP BY P.nome, P.plano_id
ORDER BY TotalFaltasAcumuladas DESC;

-- 6 - Sexo do aluno influencia na escolha da Modalidade?
WITH DistribuicaoModalidade AS (
    SELECT
        M.nome AS NomeModalidade,
        A.sexo,
        COUNT(PR.presenca_id) AS TotalOcorrencias
    FROM Alunos A
    JOIN Presencas PR ON A.aluno_id = PR.aluno_id
    JOIN Treinos T ON PR.treino_id = T.treino_id
    JOIN Modalidades M ON T.modalidade_id = M.modalidade_id
    GROUP BY M.nome, A.sexo
)
SELECT
    DM.NomeModalidade,
    CASE DM.sexo
        WHEN 'M' THEN 'Masculino'
        WHEN 'F' THEN 'Feminino'
        ELSE 'Outro'
    END AS SexoAluno,
    DM.TotalOcorrencias,
    CAST(DM.TotalOcorrencias AS DECIMAL(10,2)) * 100 / SUM(DM.TotalOcorrencias) OVER (PARTITION BY DM.NomeModalidade) AS PercentualNaModalidade
FROM DistribuicaoModalidade DM
ORDER BY DM.NomeModalidade, PercentualNaModalidade DESC;



